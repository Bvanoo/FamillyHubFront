<div class="group-details-wrapper">
  @if (groupId) {
    <header class="page-header">
      <div class="header-title-row">
        <button class="btn-icon" (click)="_nav.goBack()" aria-label="Retour">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1><i class="fas fa-users"></i> {{ groupDetails?.name || groupDetails?.Name || 'Groupe #' + groupId }}</h1>
      </div>

      <div class="header-actions">
        <div class="tabs-scroll">
          <button class="btn-tab" (click)="activeTab.set('chat')" [class.active]="activeTab() === 'chat'"><i class="fas fa-comments"></i> Chat</button>
          <button class="btn-tab" (click)="activeTab.set('randomizer')" [class.active]="activeTab() === 'randomizer'"><i class="fas fa-gift"></i> Secret Santa</button>
          <button class="btn-tab" (click)="activeTab.set('calendar')" [class.active]="activeTab() === 'calendar'"><i class="fas fa-calendar-alt"></i> Calendrier</button>
          <button class="btn-tab" (click)="activeTab.set('settings')" [class.active]="activeTab() === 'settings'"><i class="fas fa-cog"></i> Paramètres</button>
        </div>
        
        <button class="btn-primary" (click)="openInviteModal()">
          <i class="fas fa-user-plus"></i> <span class="hide-mobile">Inviter</span>
        </button>
      </div>
    </header>

    <section class="group-layout">

      @if (activeTab() === 'chat') {
        <div class="card chat-section">
          <div class="messages-container">
            @for (msg of messages(); track msg.timestamp) {
              <div class="message" [class.my-message]="msg.senderName === currentUser.name">
                <div class="msg-header">
                  <strong>{{ msg.senderName }}</strong>
                  <small>{{ msg.timestamp | date:'shortTime' }}</small>
                </div>
                <p>{{ msg.content }}</p>
              </div>
            }
          </div>

          <div class="chat-input-row">
            <input type="text" class="custom-input" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()"
              placeholder="Écrivez un message...">
            <button class="btn-primary" (click)="sendMessage()"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      }

      @if (activeTab() === 'randomizer') {
        <div class="card randomizer-section">
          <div class="secret-santa-wrapper">
            <h2 class="santa-title"><i class="fas fa-gift"></i> Secret Santa {{ currentUser?.year || '' }}</h2>

            @if (!secretSantaState().isDrawn) {
              <div class="no-draw">
                <div class="santa-icon"><i class="fas fa-dice"></i></div>
                <p class="santa-desc">Aucun tirage n'a encore été effectué pour cette année.</p>

                @if (isAdmin()) {
                  <button class="btn-santa-action" (click)="triggerSecretSanta()">
                    Lancer le tirage au sort !
                  </button>
                } @else {
                  <p class="santa-wait"><i class="fas fa-hourglass-half"></i> Attendez que l'administrateur lance le tirage.</p>
                }
              </div>
            }

            @if (secretSantaState().isDrawn && !secretSantaState().isRevealed) {
              <div class="hidden-target">
                <div class="santa-icon animated-bounce"><i class="fas fa-box"></i></div>
                <h3>Le tirage a eu lieu !</h3>
                <p class="santa-desc">Votre cible vous attend sagement dans cette boîte virtuelle.</p>
                <button class="btn-santa-reveal" (click)="revealTarget()">
                  <i class="fas fa-gift"></i> Révéler ma cible
                </button>
              </div>
            }

            @if (secretSantaState().isDrawn && secretSantaState().isRevealed) {
              <div class="target-reveal">
                <h3><i class="fas fa-glass-cheers"></i> Vous êtes le Secret Santa de :</h3>
                <div class="target-card">
                  <img [src]="secretSantaState().targetPicture ? 'https://famillyhub-arbzdag7axfpabb8.belgiumcentral-01.azurewebsites.net' + secretSantaState().targetPicture : 'assets/default-avatar.png'"
                    alt="Avatar Cible" class="target-avatar" onerror="this.src='FamHubIcon.png'">
                  <span class="target-name">{{ secretSantaState().targetName }}</span>
                </div>
                <p class="santa-secret-text">Chut ! C'est un secret. Ne le dites à personne ! <i class="fas fa-user-secret"></i></p>
              </div>
            }

            @if (isAdmin() && secretSantaState().isDrawn) {
              <div class="santa-admin-zone">
                <button class="btn-danger-outline" (click)="resetSecretSanta()">
                  <i class="fas fa-sync-alt"></i> Réinitialiser le tirage
                </button>
                <p class="admin-note">(Action Admin : annule le tirage pour tout le monde)</p>
              </div>
            }
          </div>
        </div>
      }

      @if (activeTab() === 'calendar') {
        <div class="card calendar-container">
          <app-calendar [groupId]="groupId"></app-calendar>
        </div>
      }

      @if (activeTab() === 'settings') {
        <div class="card settings-section">
          <h3 class="section-title">Membres du groupe</h3>
          <ul class="member-list">
            @for (member of members(); track member.userId) {
              <li class="member-item">
                <div class="member-info">
                  <strong>{{ member.name || member.Name }}</strong>
                  @if (member.role === 'Admin') {
                    <span class="badge-admin"><i class="fas fa-crown"></i> Admin</span>
                  }
                </div>
                @if (isAdmin() && member.role !== 'Admin') {
                  <div class="member-actions">
                    <button (click)="transferRole(member.userId, member.name || member.Name)" class="btn-primary-sm">Nommer Admin</button>
                    <button (click)="removeMember(member.userId, member.name || member.Name)" class="btn-danger-sm">Retirer</button>
                  </div>
                }
              </li>
            }
          </ul>

          @if (isAdmin()) {
            <div class="danger-zone">
              <h3>Zone de danger</h3>
              <p>La suppression du groupe entraînera la perte de tous les messages et événements liés.</p>
              <button (click)="deleteGroup()" class="btn-danger">Supprimer le groupe</button>
            </div>
          }
        </div>
      }
    </section>

    @if (showInviteModal()) {
      <div class="modal-overlay" (click)="closeInviteModal()">
        <div class="card modal-box" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Ajouter un membre</h2>
          </div>
          <div class="modal-body">
            <div class="input-group">
              <label>Nom, prénom ou email</label>
              <div class="search-row">
                <input type="text" class="custom-input" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
                  (keyup.enter)="searchUsers()" placeholder="Ex: Jean Dupont">
                <button class="btn-primary" (click)="searchUsers()">Chercher</button>
              </div>
            </div>

            @if (isSearching()) {
              <p class="search-status">Recherche en cours...</p>
            }

            @if (!isSearching() && searchResults().length === 0 && searchQuery()) {
              <p class="search-error">Aucun utilisateur trouvé.</p>
            }

            @if (searchResults().length > 0) {
              <div class="results-list">
                @for (user of searchResults(); track user.email || user.Email) {
                  <div class="result-item">
                    <div class="user-info-row">
                      <img [src]="user.profilePictureUrl || user.ProfilePictureUrl ? 'https://famillyhub-arbzdag7axfpabb8.belgiumcentral-01.azurewebsites.net' + (user.profilePictureUrl || user.ProfilePictureUrl) : 'assets/default-avatar.png'"
                        alt="Avatar" class="user-avatar" onerror="this.style.display='none'">
                      <div class="user-text">
                        <span class="user-name">{{ user.name || user.Name }}</span>
                        <span class="user-email">{{ user.email || user.Email }}</span>
                      </div>
                    </div>
                    <button (click)="inviteUser(user)" class="btn-primary-sm">Ajouter</button>
                  </div>
                }
              </div>
            }
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="closeInviteModal()">Fermer</button>
          </div>
        </div>
      </div>
    }
  }
</div>