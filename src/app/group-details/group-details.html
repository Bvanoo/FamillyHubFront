<div class="app-container" *ngIf="groupId">
  <main class="content-area">

    <header class="page-header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <button class="btn-secondary" (click)="_nav.goBack()">‚¨Ö Retour</button>
        <h1>üë• {{ groupDetails?.name || groupDetails?.Name || 'Espace du Groupe #' + groupId }}</h1>
      </div>

      <div class="header-actions">
        <button class="btn-tab" (click)="activeTab.set('chat')" [class.active]="activeTab() === 'chat'">Chat</button>
        <button class="btn-tab" (click)="activeTab.set('calendar')" [class.active]="activeTab() === 'calendar'">
          Calendrier</button>
        <button class="btn-tab" (click)="activeTab.set('settings')" [class.active]="activeTab() === 'settings'">
          Param√®tres</button>
        <button class="btn-primary" (click)="openInviteModal()">Ajouter un membre</button>
      </div>
    </header>

    <section class="group-layout">

      <div class="card chat-section" *ngIf="activeTab() === 'chat'">
        <div class="messages-container">
          <div *ngFor="let msg of messages()" class="message" [class.my-message]="msg.senderName === currentUser.name">
            <div class="msg-header">
              <strong>{{ msg.senderName }}</strong>
              <small>{{ msg.timestamp | date:'shortTime' }}</small>
            </div>
            <p>{{ msg.content }}</p>
          </div>
        </div>

        <div class="chat-input" style="display: flex; gap: 10px; margin-top: 20px;">
          <input type="text" class="custom-input" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()"
            placeholder="√âcrivez un message...">
          <button class="btn-primary" (click)="sendMessage()">Envoyer</button>
        </div>
      </div>

      <div class="card calendar-container" *ngIf="activeTab() === 'calendar'">
        <app-calendar [groupId]="groupId"></app-calendar>
      </div>

      <div class="card settings-section" *ngIf="activeTab() === 'settings'">

        <h3 style="margin-top: 0;">Membres du groupe</h3>

        <ul style="list-style: none; padding: 0; margin-bottom: 30px;">
          <li *ngFor="let member of members()"
            style="padding: 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">

            <div>
              <strong style="font-size: 1.05rem;">{{ member.name || member.Name }}</strong>
              <span *ngIf="member.role === 'Admin'"
                style="background: #fef08a; color: #854d0e; font-size: 0.75rem; font-weight: bold; padding: 3px 8px; border-radius: 12px; margin-left: 10px;">üëë
                Admin</span>
            </div>

            <div class="btn-gap">

              <button (click)="transferRole(member.userId, member.name || member.Name)" class="btn-primary"
                style="padding: 6px 12px; font-size: 0.85rem;">
                Nommer Admin
              </button>

              <button (click)="removeMember(member.userId, member.name || member.Name)" class="btn-danger"
                style="padding: 6px 12px; font-size: 0.85rem;">
                Retirer
              </button>
            </div>

          </li>
        </ul>

        <div *ngIf="isAdmin()"
          style="border: 1px solid #fca5a5; border-radius: 12px; padding: 20px; background: #fef2f2;">
          <h3 style="color: #dc2626; margin-top: 0;">Zone de danger</h3>
          <p style="font-size: 0.95rem; color: #7f1d1d; margin-bottom: 15px;">
            La suppression du groupe entra√Ænera la perte de tous les messages et √©v√©nements li√©s. Cette action est
            irr√©versible.
          </p>
          <button (click)="deleteGroup()" class="btn-danger">
            Supprimer le groupe
          </button>
        </div>

      </div>

    </section>

  </main>

  <div class="modal-overlay" *ngIf="showInviteModal()" (click)="closeInviteModal()">
    <div class="card modal-box" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h2>Ajouter un membre</h2>
      </div>

      <div class="modal-body">

        <div class="input-group">
          <label>Nom, pr√©nom ou email</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" class="custom-input" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
              (keyup.enter)="searchUsers()" placeholder="Ex: Jean Dupont">
            <button class="btn-primary" (click)="searchUsers()">Chercher</button>
          </div>
        </div>

        <p *ngIf="isSearching()" style="color: #64748b; font-style: italic; text-align: center; margin: 0;">Recherche en
          cours...</p>
        <p *ngIf="!isSearching() && searchResults().length === 0 && searchQuery()"
          style="color: #ef4444; text-align: center; margin: 0;">
          Aucun utilisateur trouv√©.
        </p>

        <div class="results-list" *ngIf="searchResults().length > 0">
          <div *ngFor="let user of searchResults()" class="result-item">

            <div class="user-info">
              <img
                [src]="user.profilePictureUrl || user.ProfilePictureUrl ? 'https://localhost:7075' + (user.profilePictureUrl || user.ProfilePictureUrl) : 'assets/default-avatar.png'"
                alt="Avatar" class="user-avatar" onerror="this.style.display='none'">
              <div class="user-text">
                <span class="user-name">{{ user.name || user.Name }}</span>
                <span class="user-email">{{ user.email || user.Email }}</span>
              </div>
            </div>

            <button (click)="inviteUser(user)" class="btn-primary" style="padding: 6px 12px; font-size: 0.85rem;">
              Ajouter
            </button>

          </div>
        </div>

      </div>

      <div class="modal-footer">
        <div></div>
        <div class="right-actions">
          <button class="btn-cancel" (click)="closeInviteModal()">Fermer</button>
        </div>
      </div>

    </div>
  </div>
</div>