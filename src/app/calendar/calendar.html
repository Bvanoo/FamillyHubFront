<div class="calendar-wrapper">

  @if (!groupId()) {
  <header class="page-header">
    <h1>Planning & Dispos</h1>
  </header>
  }

  <section class="calendar-layout" [class.full-width]="groupId()">

    @if (!groupId()) {
    <aside class="card sidebar-config">
      <div class="config-section">
        <h3>Instructions</h3>
        <p class="instruction-text">
          Cliquez sur un créneau pour ajouter un événement.
          Glissez pour définir la durée.
        </p>
      </div>

      <div class="config-section status-legend">
        <h3>Légende</h3>
        <ul>
          <li><span class="badge blue"></span> Groupe (Partagé)</li>
          <li><span class="badge green"></span> Perso (Disponible)</li>
          <li><span class="badge yellow"></span> Perso (Privé)</li>
          <li><span class="badge red"></span> Perso (Masqué)</li>
        </ul>
      </div>
    </aside>
    }

    <div class="card calendar-card">
      <full-calendar [options]="calendarOptions"></full-calendar>
    </div>

  </section>

  @if (showModal) {
  <div class="modal-overlay" (click)="closeModal()">

    <div class="modal-box" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h2>{{ isEditMode ? 'Modifier l\'événement' : 'Nouvel événement' }}</h2>
      </div>

      <div class="modal-body">

        <div class="input-group">
          <label>Titre de l'événement</label>
          <input type="text" class="custom-input" [(ngModel)]="tempEvent.title"
            placeholder="Ex: Repas de famille, Dentiste...">
        </div>

        <div class="input-row">
          <div class="input-group">
            <label>Date et heure de début</label>
            <input type="datetime-local" class="custom-input" [(ngModel)]="tempEvent.start">
          </div>
          <div class="input-group">
            <label>Date et heure de fin</label>
            <input type="datetime-local" class="custom-input" [(ngModel)]="tempEvent.end">
          </div>
        </div>

        @if (tempEvent.groupId === null) {
        <div class="input-group">
          <label>Confidentialité</label>
          <div class="checkbox-row">
            <label class="checkbox-label" title="Visible uniquement par moi">
              <input type="checkbox" [(ngModel)]="tempEvent.isPrivate">
              Privé
            </label>
            <label class="checkbox-label" title="Les autres verront 'Occupé'">
              <input type="checkbox" [(ngModel)]="tempEvent.maskDetails" [disabled]="tempEvent.isPrivate">
              Masquer détails
            </label>
          </div>
        </div>
        }

        <div class="color-picker-group">
          <label>Couleur</label>

          @if (tempEvent.groupId === null) {
          <div class="color-presets">
            <div class="color-swatch" [style.background-color]="'#3b82f6'" (click)="tempEvent.color = '#3b82f6'"
              [class.active]="tempEvent.color === '#3b82f6'"></div>
            <div class="color-swatch" [style.background-color]="'#10b981'" (click)="tempEvent.color = '#10b981'"
              [class.active]="tempEvent.color === '#10b981'"></div>
            <div class="color-swatch" [style.background-color]="'#f59e0b'" (click)="tempEvent.color = '#f59e0b'"
              [class.active]="tempEvent.color === '#f59e0b'"></div>
            <div class="color-swatch" [style.background-color]="'#ef4444'" (click)="tempEvent.color = '#ef4444'"
              [class.active]="tempEvent.color === '#ef4444'"></div>
          </div>
          }

          @if (tempEvent.groupId !== null) {
          <p style="font-size:0.9rem; color:#64748b; margin-bottom:10px;">
            Les événements de groupe utilisent la couleur du groupe.
          </p>
          }

          <div class="custom-color-section">
            <input type="color" class="rect-color-input" [(ngModel)]="tempEvent.color"
              [disabled]="tempEvent.groupId !== null">
          </div>
          <hr class="separator">

          @if (isEditMode) {
          <div class="tasks-section">
            <h3><i class="fas fa-tasks"></i> Tâches à faire ({{ tempEvent.tasks?.length || 0 }})</h3>

           <ul class="task-list">
                @for (task of tempEvent.tasks; track task.id || task.Id) {
                  
                  <li class="task-item" [class.completed]="task.isCompleted">
                    
                    <input type="checkbox" 
                           class="task-checkbox" 
                           [checked]="task.isCompleted" 
                           (change)="toggleTaskStatus(task)">

                    <div class="task-info">
                      <span class="task-title">{{ task.title || task.Title }}</span>
                      
                      @if ((task.assignedUserNames?.length > 0) || (task.AssignedUserNames?.length > 0)) {
                        <span class="task-assignees">
                          <i class="fas fa-user-tag"></i> {{ (task.assignedUserNames || task.AssignedUserNames).join(', ') }}
                        </span>
                      }
                    </div>

                    <button class="btn-icon-danger" (click)="deleteTask(task.id || task.Id)" title="Supprimer">
                      <i class="fas fa-trash-alt"></i>
                    </button>

                  </li>
                }
                
                @if (tempEvent.tasks?.length === 0) {
                  <p class="no-tasks">Aucune tâche pour le moment.</p>
                }
              </ul>

            <div class="add-task-form card-light">
              <div class="input-group">
                <input type="text" class="custom-input" [(ngModel)]="newTaskTitle" (keyup.enter)="addTask()"
                  placeholder="Ex: Acheter le pain, Réserver la salle...">
              </div>

              @if (tempEvent.groupId) {
              <div class="input-group">
                <label>Assigner à (optionnel)</label>
                <select multiple class="custom-input select-multiple" [(ngModel)]="newTaskAssignedUserIds">
                  @for (member of groupMembers; track member.userId || member.UserId) {
                  <option [value]="member.userId || member.UserId">{{ member.name || member.Name }}</option>
                  }
                </select>
                <small class="help-text">Maintenez CTRL (ou CMD sur Mac) pour en sélectionner plusieurs</small>
              </div>
              }

              <button class="btn-secondary" (click)="addTask()" [disabled]="!newTaskTitle.trim() || isAddingTask">
                @if (isAddingTask) {
                <i class="fas fa-spinner fa-spin"></i> Ajout en cours...
                } @else {
                <i class="fas fa-plus"></i> Ajouter la tâche
                }
              </button>
            </div>
          </div>
          } @else {
          <div class="tasks-info-box">
            <i class="fas fa-info-circle"></i> <span>Sauvegardez l'événement une première fois pour pouvoir y ajouter
              des tâches.</span>
          </div>
          }
        </div>

      </div>

      <div class="modal-footer">
        @if (isEditMode) {
        <button class="btn-danger" (click)="deleteEvent()">Supprimer</button>
        } @else {
        <div></div>
        }

        <div class="right-actions">
          <button class="btn-cancel" (click)="closeModal()">Annuler</button>
          <button class="btn-primary" (click)="saveEvent()">
            {{ isEditMode ? 'Mettre à jour' : 'Enregistrer' }}
          </button>
        </div>
      </div>

    </div>
  </div>
  }
</div>
@if (toastVisible) {
  <div class="toast-container" [ngClass]="toastType">
    <div class="toast-content">
      @if (toastType === 'success') { <i class="fas fa-check-circle"></i> }
      @if (toastType === 'error') { <i class="fas fa-exclamation-triangle"></i> }
      @if (toastType === 'info') { <i class="fas fa-info-circle"></i> }
      <span>{{ toastMessage }}</span>
    </div>
  </div>
}

@if (confirmModal.isOpen) {
  <div class="modal-overlay" style="z-index: 10000;">
    <div class="modal-box confirm-box">
      <div class="modal-header">
        <h2>{{ confirmModal.title }}</h2>
      </div>
      <div class="modal-body">
        <p>{{ confirmModal.message }}</p>
      </div>
      <div class="modal-footer right-actions">
        <button class="btn-cancel" (click)="closeConfirm()">Annuler</button>
        <button class="btn-danger" (click)="confirmModal.onConfirm()">Confirmer</button>
      </div>
    </div>
  </div>
}